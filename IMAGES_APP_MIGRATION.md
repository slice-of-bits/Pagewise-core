# Images App Migration - Implementation Summary

## Overview
This implementation moves the Image model from the `documents` app to a new dedicated `images` app, implements AI-generated alt text for images using Ollama with qwen-2vl model, and updates the URL structure to use SEO-friendly paths.

## Key Changes

### 1. New Images Django App
Created a dedicated `images` app with the following structure:
- **models.py**: Image model with enhanced functionality
  - `alt_text` field for AI-generated descriptions
  - `filename` property that generates clean filenames from alt text
  - `url_path` property that returns `/sqid/filename.ext` format
  - `clean_filename()` utility function for consistent filename cleaning

- **views.py**: Image redirect view
  - Handles both `/sqid/filename.ext` and legacy `/image/sqid` URLs
  - Redirects to actual image file URL in storage

- **tasks.py**: Asynchronous task processing
  - `extract_images_from_page`: Extracts images from OCR results
  - `generate_image_alt_text`: Uses Ollama with qwen-2vl to generate alt text

- **admin.py**: Admin interface for image management

### 2. URL Structure Changes
**Old Format:**
```
/image/{sqid}
```

**New Format:**
```
/{sqid}/{filename}.{ext}
```

Where `filename` is derived from the AI-generated alt text, cleaned and sanitized for use in URLs.

**Benefits:**
- SEO-friendly URLs with descriptive filenames
- Better accessibility with meaningful alt text
- Backwards compatible with legacy `/image/sqid` format

### 3. Alt Text Generation Workflow

1. Page is processed by OCR
2. Images are extracted and saved to the database
3. `extract_images_from_page` task is called with image data
4. For each image:
   - Image is saved to storage
   - `generate_image_alt_text` task is triggered asynchronously
   - Ollama with qwen-2vl model generates a concise description
   - Alt text is saved to the database
   - Filename property uses alt text for URL generation

### 4. Configuration

**Environment Variables:**
```bash
# Ollama host for OCR and image alt text
OLLAMA_HOST=http://localhost:11434

# Model to use for generating image alt text
IMAGE_ALT_TEXT_MODEL=qwen2-vl
```

### 5. Document Processing Updates

The `process_page` task in documents/tasks.py now:
1. Processes page with OCR
2. Calls `extract_images_from_page` synchronously to get image SQIDs
3. Retrieves Image objects to get their `url_path` property
4. Replaces placeholder URLs with actual `/sqid/filename.ext` URLs
5. Removes orphaned placeholders for failed extractions

### 6. Migration Path

**For existing deployments:**
1. Apply migrations: `python manage.py migrate`
2. Existing images will still work with the legacy `/image/sqid` URL
3. New images will automatically use the new `/sqid/filename.ext` format
4. Alt text generation is asynchronous and won't block processing

**Data migration:**
- Old Image records will be preserved
- They can still be accessed via their sqid
- Alt text can be regenerated by reprocessing pages

### 7. Code Quality

**Security:**
- CodeQL scan: 0 alerts found
- No security vulnerabilities introduced
- Proper input sanitization for filenames

**Best Practices:**
- Extracted shared utility functions
- Configurable model selection
- Proper error handling and logging
- Backwards compatible URL structure

## Testing

**Django Configuration:**
```bash
python manage.py check
# Output: System check identified no issues (0 silenced).
```

**Security Scan:**
```bash
# CodeQL security analysis
# Result: 0 alerts found
```

## API Impact

**No breaking changes to existing API endpoints:**
- Image URLs in markdown are automatically updated during processing
- Old images continue to work with existing URLs
- New images use the enhanced URL format

**Image endpoint remains the same:**
```
GET /api/images/{sqid}
```

Returns image metadata including alt_text field.

## Future Enhancements

1. **Batch Alt Text Generation**: Add management command to regenerate alt text for existing images
2. **Multi-language Support**: Generate alt text in multiple languages
3. **Customizable Prompts**: Allow configuration of the alt text generation prompt
4. **Alt Text Quality Scoring**: Track and improve alt text quality metrics
5. **Image Analysis**: Extract additional metadata (colors, objects, text)

## Rollback Plan

If issues arise:
1. Revert to previous commit
2. Old migrations can be manually applied if needed
3. Database schema is backwards compatible
4. No data loss - Image model structure unchanged except for added alt_text field

## Support

For questions or issues:
1. Check Django logs for error messages
2. Verify Ollama service is running and accessible
3. Ensure qwen-2vl model is pulled: `ollama pull qwen2-vl`
4. Check environment variables are set correctly
